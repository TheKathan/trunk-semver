name: Test and Release

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Action
        run: |
          if [ ! -f action.yml ]; then
            echo "action.yml not found"
            exit 1
          fi
          echo "Action file validated"

      - name: Create Release Version
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        id: version
        uses: ./
        with:
          major-version: "1"
          enable-prerelease: "false"

      - name: Display Version
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "Created version: ${{ steps.version.outputs.version }}"
          echo "Is prerelease: ${{ steps.version.outputs.is-prerelease }}"

      - name: Create GitHub Release
        if: github.event_name == 'push' && github.ref == 'refs/heads/main' && steps.version.outputs.skip_tag != 'true'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create ${{ steps.version.outputs.version }} \
            --title "${{ steps.version.outputs.version }}" \
            --generate-notes
